<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shortlink 🔗</title>
  <meta name="description" content="Static shortlink on GitHub Pages (super simple)">

  <script>
    /* ===== KONFIG =====
       Project Pages: BASE_PATH = "/<repo>";
       User/Org Pages: BASE_PATH = "";
    */
    const OWNER     = "n45pnasp";
    const REPO      = "shortlink";
    const BRANCH    = "main";
    const JSON_PATH = "links.json";
    const BASE_PATH = "/shortlink";
  </script>

  <link rel="stylesheet" href="style.css" />
  <style>
    /* ====== Modal login + blur ====== */
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px }
    .pill{ padding:8px 12px; border:1px solid var(--border,rgba(255,255,255,.12));
      border-radius:12px; background:transparent; color:var(--text,#e5e7eb); cursor:pointer }
    .pill:hover{ background:rgba(255,255,255,.06) }
    #authHint{ margin:4px 0 14px; color:var(--muted,#9ca3af); font-size:13px }

    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      display:none; z-index:60 }
    .overlay.show{ display:block }
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:70 }
    .modal.show{ display:grid }
    .modal .card{
      width:min(420px,92vw); background:var(--panel,#111827);
      border:1px solid var(--border,rgba(255,255,255,.1)); border-radius:16px;
      padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.45)
    }
    .modal h3{ margin:0 0 8px }
    .modal p{ margin:0 0 12px; color:var(--muted,#9ca3af) }
    .modal label{ display:block; font-size:14px; margin:10px 0 6px }
    .modal input{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid var(--border,rgba(255,255,255,.12));
      background:#0b1324; color:#e5e7eb;
    }
    .rowbtn{ display:flex; gap:10px; margin-top:14px }
    .btn{ appearance:none; border:none; padding:10px 14px; border-radius:12px; cursor:pointer;
      color:white; background:linear-gradient(180deg,#60a5fa,#3b82f6) }
    .btn.secondary{ background:#0a1224; color:var(--text,#e5e7eb); border:1px solid var(--border,rgba(255,255,255,.12)) }
    .muted{ color:var(--muted,#9ca3af) }
    .danger{ color:#f87171 }
    .delBtn{ margin-left:6px; background:none; border:none; color:#f87171; cursor:pointer; font-size:14px }
    .delBtn:hover{ color:#dc2626 }
    .blurred{ filter: blur(3px); transform: translateZ(0) }
  </style>
</head>
<body>
  <main class="container" id="appRoot">
    <div class="topbar">
      <h1>Shortlink 🔗</h1>
      <div>
        <button id="btnLogin" class="pill">Login</button>
        <button id="btnLogout" class="pill" style="display:none">Logout</button>
      </div>
    </div>
    <div id="authHint">Belum login.</div>

    <p>Masukkan URL, klik <b>Generate</b>, dapatkan shortlink. Simple.</p>

    <section class="card">
      <div class="grid">
        <label>Target URL
          <input id="target" placeholder="https://contoh.com/halaman" />
        </label>
        <label>Slug (opsional)
          <input id="slug" placeholder="kosongkan untuk auto (6-karakter)" />
        </label>
      </div>
      <div class="actions">
        <button id="btnGen" disabled>Generate</button>
        <button id="btnCopy" disabled>Copy</button>
        <button id="btnReset" class="pill" title="Hapus token GitHub dari browser">Reset Token</button>
      </div>
      <p id="status" class="muted"></p>
      <p id="out" class="big"></p>
    </section>

    <section class="card">
      <h2>Daftar Link</h2>
      <ul id="list"></ul>
    </section>
  </main>

  <!-- Overlay & Modal Login -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>
  <div id="loginModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="card">
      <h3 id="loginTitle">Masuk</h3>
      <p id="loginDesc">Gunakan akun email/password yang terdaftar di Firebase.</p>

      <!-- FORM login agar Enter otomatis submit -->
      <form id="loginForm">
        <label>Email</label>
        <input id="email" type="email" autocomplete="username" placeholder="nama@contoh.com" />
        <label>Password</label>
        <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />
        <div class="rowbtn">
          <button id="doLogin" type="submit" class="btn">Login</button>
          <button id="cancelLogin" type="button" class="btn secondary">Batal</button>
        </div>
        <p id="loginInfo" class="muted"></p>
      </form>
    </div>
  </div>

  <!-- Firebase v9 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyAjqMqmKUDPWHkv19Dig7PnUpHMzNf9J1A",
      authDomain: "onlinecsbwx.firebaseapp.com",
      databaseURL: "https://onlinecsbwx-default-rtdb.firebaseio.com",
      projectId: "onlinecsbwx",
      storageBucket: "onlinecsbwx.firebasestorage.app",
      messagingSenderId: "317019843909",
      appId: "1:317019843909:web:2d5b2b2c9dd118e0ce622c",
      measurementId: "G-S1V334CNHC"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const $ = (s,el=document)=>el.querySelector(s);
    const appRoot     = $("#appRoot");
    const overlay     = $("#overlay");
    const modal       = $("#loginModal");
    const loginForm   = $("#loginForm");
    const btnLogin    = $("#btnLogin");
    const btnLogout   = $("#btnLogout");
    const doLogin     = $("#doLogin");
    const cancelLogin = $("#cancelLogin");
    const loginInfo   = $("#loginInfo");
    const loginDesc   = $("#loginDesc");
    const authHint    = $("#authHint");

    function openModal(){
      overlay.classList.add("show");
      modal.classList.add("show");
      appRoot.classList.add("blurred");
      loginInfo.textContent = "";
      $("#email").focus();
    }
    function closeModal(){
      overlay.classList.remove("show");
      modal.classList.remove("show");
      appRoot.classList.remove("blurred");
    }

    btnLogin.onclick = openModal;
    cancelLogin.onclick = closeModal;

    async function handleLogin(){
      loginInfo.textContent = "Memproses…";
      doLogin.disabled = true;
      try{
        const email = $("#email").value.trim();
        const pass  = $("#password").value;
        await signInWithEmailAndPassword(auth, email, pass);
        loginInfo.textContent = "Berhasil masuk.";
        setTimeout(closeModal, 250);
        setTimeout(()=>$("#target")?.focus(), 300);
      }catch(e){
        loginInfo.textContent = "Gagal: " + (e?.message || e);
      }finally{
        doLogin.disabled = false;
      }
    }
    // Klik tombol Login
    doLogin.onclick = (e)=>{ e.preventDefault(); handleLogin(); };
    // ENTER di form login
    loginForm.addEventListener("submit",(e)=>{ e.preventDefault(); handleLogin(); });

    btnLogout.onclick = async ()=>{ await signOut(auth); };

    function setAuthUI(user){
      const gen = $("#btnGen"), copy = $("#btnCopy");
      if (user){
        btnLogin.style.display = "none";
        btnLogout.style.display = "";
        gen.disabled = false;
        authHint.textContent = `Masuk sebagai: ${user.email||"akun"}`;
        loginDesc.textContent = "Anda sudah login.";
        loginInfo.textContent = `Masuk sebagai: ${user.email||"akun"}`;
        closeModal();
      }else{
        btnLogin.style.display = "";
        btnLogout.style.display = "none";
        gen.disabled = true;
        copy.disabled = true;
        authHint.textContent = "Belum login.";
        openModal();
      }
    }

    // Tampilkan modal di awal; tutup otomatis jika sudah login
    openModal();
    onAuthStateChanged(auth, setAuthUI);

    /* ========================
       TOKEN GITHUB (persisten)
       - set via ?token=... atau #token=...
       - disimpan localStorage
       - fallback prompt saat butuh write
    =========================*/
    const tokenKey = "gh_token_shortlink_v2";
    function requireToken(){
      let t = localStorage.getItem(tokenKey);
      if (!t) {
        const q = new URLSearchParams(location.search);
        const h = new URLSearchParams(location.hash.replace(/^#/, ""));
        const fromUrl = q.get("token") || h.get("token") || q.get("gh") || h.get("gh");
        if (fromUrl) {
          t = fromUrl.trim();
          localStorage.setItem(tokenKey, t);
          history.replaceState(null, "", location.pathname);
        }
      }
      if (!t) {
        t = prompt("Tempel GitHub Token (contents: read & write untuk repo ini):");
        if (!t) throw new Error("Token dibutuhkan untuk menyimpan ke GitHub.");
        localStorage.setItem(tokenKey, t.trim());
      }
      return t;
    }
    window.clearToken = function(){ localStorage.removeItem(tokenKey); alert("Token dihapus."); };

    /* =========== Util =========== */
    function buildShort(slug){
      const base = (BASE_PATH||"").replace(/\/+$/,'');
      const s = String(slug||'').trim().toLowerCase().replace(/^\/+|\/+$/g,'');
      return location.origin + (base||"") + "/" + s;
    }
    function randomSlug(n=6){
      const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
      return Array.from({length:n},()=>chars[Math.floor(Math.random()*chars.length)]).join("");
    }

    /* ======= GitHub API (WRITE) ======= */
    function ghApi(path, init={}){
      const headers = Object.assign({
        "Accept":"application/vnd.github+json",
        "Authorization":"Bearer " + requireToken()
      }, init.headers||{});
      return fetch("https://api.github.com"+path, {...init, headers});
    }
    async function getFile(){
      const res = await ghApi(`/repos/${OWNER}/${REPO}/contents/${JSON_PATH}?ref=${BRANCH}`);
      if(res.status===404) return {json:{}, sha:null};
      if(!res.ok) throw new Error("GET contents gagal: " + res.status);
      const data = await res.json();
      const content = atob((data.content||"").replace(/\n/g,""));
      return {json: JSON.parse(content||"{}"), sha: data.sha};
    }
    async function putFile(jsonObj, prevSha){
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonObj, null, 2))));
      const body = { message:`chore: update ${JSON_PATH}`, content, branch: BRANCH };
      if (prevSha) body.sha = prevSha;
      const res = await ghApi(`/repos/${OWNER}/${REPO}/contents/${JSON_PATH}`, {
        method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error("PUT contents gagal: " + res.status + " " + t);
      }
      return res.json();
    }

    /* ======= Daftar link (NO TOKEN) ======= */
    async function refreshList(){
      const ul = $("#list"); ul.innerHTML = "<li class='muted'>Memuat…</li>";
      try{
        const listURL = (BASE_PATH || "") + "/links.json?ts=" + Date.now();
        const r = await fetch(listURL, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const json = await r.json();

        const keys = Object.keys(json).sort();
        ul.innerHTML = keys.length ? "" : "<li class='muted'>Belum ada link.</li>";
        for(const k of keys){
          const short = buildShort(k);
          const li = document.createElement("li");
          li.innerHTML = `
            <code>${k}</code> → 
            <a href="${json[k]}" target="_blank" rel="noopener">${json[k]}</a> | 
            <a href="${short}" target="_blank" rel="noopener">short</a>
            <button class="delBtn" data-slug="${k}" title="Hapus">❌</button>
          `;
          ul.appendChild(li);
        }
        // pasang event delete
        ul.querySelectorAll(".delBtn").forEach(btn=>{
          btn.onclick = ()=> deleteSlug(btn.dataset.slug);
        });
      }catch(e){
        ul.innerHTML = `<li class='muted'>Gagal memuat daftar: ${e.message}</li>`;
      }
    }

    /* ======= Hapus slug ======= */
    async function deleteSlug(slug){
      if (!auth.currentUser){ openModal(); return; }
      if(!confirm(`Yakin hapus shortlink "${slug}"?`)) return;
      const status = $("#status"); status.textContent = "Menghapus…";
      try{
        const {json, sha} = await getFile();
        if (!json[slug]) throw new Error("Slug tidak ditemukan di file.");
        delete json[slug];
        await putFile(json, sha);
        status.textContent = "✅ Slug dihapus.";
        refreshList();
      }catch(e){
        status.textContent = "❌ " + e.message;
        console.error(e);
      }
    }

    /* ======= Generate ======= */
    $("#btnGen").onclick = async ()=>{
      if (!auth.currentUser){ openModal(); return; }

      const status = $("#status"); const out=$("#out"); const btnCopy=$("#btnCopy");
      status.textContent = ""; out.textContent = ""; btnCopy.disabled = true;

      try{
        const url = ($("#target").value||"").trim();
        if(!/^https?:\/\//i.test(url)) throw new Error("Target harus URL (http/https).");
        let slug = ($("#slug").value||"").trim().toLowerCase().replace(/^\/+|\/+$/g,'');
        if(!slug) slug = randomSlug();

        status.textContent = "Menyimpan ke GitHub…";
        const {json, sha} = await getFile();

        if (json[slug]) slug = randomSlug();
        json[slug] = url;
        await putFile(json, sha);

        const shortUrl = buildShort(slug);
        out.innerHTML = `✅ <a href="${shortUrl}" target="_blank" rel="noopener">${shortUrl}</a>`;
        status.textContent = "Tersimpan.";
        btnCopy.disabled = false;
        btnCopy.onclick = async ()=>{
          try{ await navigator.clipboard.writeText(shortUrl); status.textContent = "Disalin ke clipboard."; }
          catch{ status.textContent = shortUrl; alert("Clipboard tidak tersedia."); }
        };

        refreshList();
      }catch(e){
        status.textContent = "❌ " + e.message;
        console.error(e);
      }
    };

    // reset token github
    $("#btnReset").onclick = ()=>{
      localStorage.removeItem("gh_token_shortlink_v2");
      sessionStorage.removeItem("gh_token_shortlink_v2");
      alert("Token GitHub dihapus. Set ulang via ?token=... atau klik Generate.");
      location.reload();
    };

    refreshList();
  </script>
</body>
</html>
