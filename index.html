<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shortlink üîó</title>
  <meta name="description" content="Static shortlink on GitHub Pages (super simple)">
  
/* url untuk memasukkan token baru (https://n45pnasp.github.io/shortlink/?token=GH_TOKEN_KAMU)*/
  
  <script>
    /* ===== KONFIGURASI =====
       Project Pages: BASE_PATH = "/<repo>";
       User/Org Pages: BASE_PATH = "";
    */
    const OWNER     = "n45pnasp";
    const REPO      = "shortlink";
    const BRANCH    = "main";
    const JSON_PATH = "links.json";
    const BASE_PATH = "/shortlink";
  </script>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h1>Shortlink üîó</h1>
    <p>Masukkan URL, klik <b>Generate</b>, dapatkan shortlink. Simple.</p>

    <section class="card">
      <div class="grid">
        <label>Target URL
          <input id="target" placeholder="https://contoh.com/halaman" />
        </label>
        <label>Slug (opsional)
          <input id="slug" placeholder="kosongkan untuk auto (6-karakter)" />
        </label>
      </div>
      <div class="actions">
        <button id="btnGen">Generate</button>
        <button id="btnCopy" disabled>Copy</button>
      </div>
      <p id="status" class="muted"></p>
      <p id="out" class="big"></p>
    </section>

    <section class="card">
      <h2>Daftar Link</h2>
      <ul id="list"></ul>
    </section>
  </main>

  <script type="module">
    const $ = (s,el=document)=>el.querySelector(s);

    /* ========================
       TOKEN GITHUB (persisten)
       - bisa set via URL: ?token=... / #token=... / ?gh=...
       - disimpan ke localStorage (sekali untuk semua sesi)
       - fallback prompt hanya saat pertama kali butuh write
    =========================*/
    const tokenKey = "gh_token_shortlink_v2";
    function requireToken(){
      let t = localStorage.getItem(tokenKey);

      if (!t) {
        const q = new URLSearchParams(location.search);
        const h = new URLSearchParams(location.hash.replace(/^#/, ""));
        const fromUrl = q.get("token") || h.get("token") || q.get("gh") || h.get("gh");
        if (fromUrl) {
          t = fromUrl.trim();
          localStorage.setItem(tokenKey, t);
          history.replaceState(null, "", location.pathname);
        }
      }

      if (!t) {
        t = prompt("Tempel GitHub Token (contents: read & write untuk repo ini):");
        if (!t) throw new Error("Token dibutuhkan untuk menyimpan ke GitHub.");
        localStorage.setItem(tokenKey, t.trim());
      }
      return t;
    }
    // opsional: panggil dari console bila ingin menghapus token
    window.clearToken = function(){ localStorage.removeItem(tokenKey); alert("Token dihapus."); };

    /* =========== Util =========== */
    function buildShort(slug){
      const base = (BASE_PATH||"").replace(/\/+$/,'');
      const s = String(slug||'').trim().toLowerCase().replace(/^\/+|\/+$/g,'');
      return location.origin + (base||"") + "/" + s;
    }
    function randomSlug(n=6){
      const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
      return Array.from({length:n},()=>chars[Math.floor(Math.random()*chars.length)]).join("");
    }

    /* ======= GitHub API (untuk WRITE saja) ======= */
    function ghApi(path, init={}){
      const headers = Object.assign({
        "Accept":"application/vnd.github+json",
        "Authorization":"Bearer " + requireToken()
      }, init.headers||{});
      return fetch("https://api.github.com"+path, {...init, headers});
    }
    async function getFile(){
      const res = await ghApi(`/repos/${OWNER}/${REPO}/contents/${JSON_PATH}?ref=${BRANCH}`);
      if(res.status===404) return {json:{}, sha:null};
      if(!res.ok) throw new Error("GET contents gagal: " + res.status);
      const data = await res.json();
      const content = atob((data.content||"").replace(/\n/g,""));
      return {json: JSON.parse(content||"{}"), sha: data.sha};
    }
    async function putFile(jsonObj, prevSha){
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonObj, null, 2))));
      const body = { message:`chore: update ${JSON_PATH}`, content, branch: BRANCH };
      if (prevSha) body.sha = prevSha;
      const res = await ghApi(`/repos/${OWNER}/${REPO}/contents/${JSON_PATH}`, {
        method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error("PUT contents gagal: " + res.status + " " + t);
      }
      return res.json();
    }

    /* ======= Tampilkan daftar link (NO TOKEN) ======= */
    async function refreshList(){
      const ul = $("#list"); ul.innerHTML = "<li class='muted'>Memuat‚Ä¶</li>";
      try{
        const listURL = (BASE_PATH || "") + "/links.json?ts=" + Date.now();
        const r = await fetch(listURL, { cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const json = await r.json();

        const keys = Object.keys(json).sort();
        ul.innerHTML = keys.length ? "" : "<li class='muted'>Belum ada link.</li>";
        for(const k of keys){
          const short = buildShort(k);
          const li = document.createElement("li");
          li.innerHTML = `<code>${k}</code> ‚Üí <a href="${json[k]}" target="_blank" rel="noopener">${json[k]}</a> | <a href="${short}" target="_blank" rel="noopener">short</a>`;
          ul.appendChild(li);
        }
      }catch(e){
        ul.innerHTML = `<li class='muted'>Gagal memuat daftar: ${e.message}</li>`;
      }
    }

    /* ======= Generate shortlink ======= */
    $("#btnGen").onclick = async ()=>{
      const status = $("#status"); const out=$("#out"); const btnCopy=$("#btnCopy");
      status.textContent = ""; out.textContent = ""; btnCopy.disabled = true;

      try{
        const url = ($("#target").value||"").trim();
        if(!/^https?:\/\//i.test(url)) throw new Error("Target harus URL (http/https).");
        let slug = ($("#slug").value||"").trim().toLowerCase().replace(/^\/+|\/+$/g,'');
        if(!slug) slug = randomSlug();

        status.textContent = "Menyimpan ke GitHub‚Ä¶";
        const {json, sha} = await getFile();

        // hindari tabrakan slug
        if (json[slug]) slug = randomSlug();

        json[slug] = url;
        await putFile(json, sha);

        const shortUrl = buildShort(slug);
        out.innerHTML = `‚úÖ <a href="${shortUrl}" target="_blank" rel="noopener">${shortUrl}</a>`;
        status.textContent = "Tersimpan.";
        btnCopy.disabled = false;
        btnCopy.onclick = async ()=>{
          try{ await navigator.clipboard.writeText(shortUrl); status.textContent = "Disalin ke clipboard."; }
          catch{ status.textContent = shortUrl; alert("Clipboard tidak tersedia."); }
        };

        refreshList();
      }catch(e){
        status.textContent = "‚ùå " + e.message;
        console.error(e);
      }
    };

    refreshList();
  </script>
</body>
</html>
